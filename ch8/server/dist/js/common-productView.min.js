function getInitState(){return{orderedProducts:{},account:"",name:"",mobile:"",email:"",address:"",cardZone1:"",cardZone2:"",cardZone3:"",cardZone4:"",cardSec:"",cardExpMonth:"",cardExpYear:""}}var state=getInitState();function renderDialogForm(){var e=document.querySelector('[js-dom = "order-form"]');[e.querySelector("#name"),e.querySelector("#mobile"),e.querySelector("#email"),e.querySelector("#address"),e.querySelector("#cardZone1"),e.querySelector("#cardZone2"),e.querySelector("#cardZone3"),e.querySelector("#cardZone4"),e.querySelector("#cardSec"),e.querySelector("#cardExpMonth"),e.querySelector("#cardExpYear")].forEach(function(e){var t=e.getAttribute("id");e.value=state[t]})}function initDialogForm(){var e=document.querySelector('[js-dom = "order-form"]');[e.querySelector("#name"),e.querySelector("#mobile"),e.querySelector("#email"),e.querySelector("#address"),e.querySelector("#cardZone1"),e.querySelector("#cardZone2"),e.querySelector("#cardZone3"),e.querySelector("#cardZone4"),e.querySelector("#cardSec"),e.querySelector("#cardExpMonth"),e.querySelector("#cardExpYear")].forEach(function(e){var t=e.getAttribute("id"),r=void 0;e.addEventListener("input",function(e){state[t]=e.target.value,clearTimeout(r),r=setTimeout(function(){reqPutOrderContact(t,e.target.value)},600)})})}function request(e,t,r,o){xhr=new XMLHttpRequest,"function"==typeof o&&xhr.addEventListener("load",o(xhr)),xhr.open(e,t),xhr.setRequestHeader("Content-Type","application/json"),r?xhr.send(JSON.stringify(r)):xhr.send()}function reqGetOrder(){request("GET","/order",void 0,function(r){return function(){var e=r.status,t=JSON.parse(r.response);if(200===e){for(key in t)state[key]=t[key]||"";renderCart(),renderDialogForm()}}})}function reqPutOrderQuantity(e){request("PUT","/order-quantity",e)}function reqDeleteOrderQuantity(e){request("DELETE","/order-quantity",e)}function reqPutOrderContact(e,t){request("PUT","/order-contact",{key:e,value:t})}function getOrderedProductsSummary(e){var t=0,r=0;for(var o in e)t+=e[o].quantity,r+=e[o].quantity*e[o].price;return{totalQuantity:t,totalPrice:r}}function preventAll(e){e.stopPropagation(),e.preventDefault()}function renderCart(){var e=document.querySelector('[js-dom = "cart-quantity"]'),t=getOrderedProductsSummary(state.orderedProducts);e.innerHTML=t.totalQuantity}function initDialog(){var e=document.querySelector('[js-dom = "cart"]'),u=document.querySelector('[js-dom = "overlay"]'),t=document.querySelector('[js-dom = "close-dialog"]');document.querySelector('[js-dom = "dialog-product-list"');function r(e){xhr=new XMLHttpRequest,xhr.addEventListener("load",function(){var e=xhr.status,t=xhr.response;200===e?(console.log(t),console.log(e,"=> 表示request成功且有資料要回給瀏覽器後續使用. 例如搜尋"),state.orderedProducts={},renderCart(),o(),u.classList.remove("active")):204===e?console.log(e,"=> 表示request成功但沒有資料要回給瀏覽器使用. 例如改密碼."):400===e?console.log(e,'=> 表示request失敗, 原因是送給server的data格式不正確. 例如formData少送一個key "email"給server.'):401===e?console.log(e,"=> 表示request失敗, 原因是使用者沒有權限. 例如需要登入的網站但使用者沒登入."):404===e?console.log(e,"=> 表示request失敗, 原因是無此資源(網頁不存在 或 server不開放), 例如打錯網址."):500===e?console.log(e,"=> 表示request失敗, 原因是server內部有不明的錯誤(Internal Server Error)."):console.log(e,"=> 表示request失敗, 原因是請再參考其他status code的列表.")}),xhr.open("POST","/confirm-payment"),xhr.setRequestHeader("Content-Type","application/json"),xhr.setRequestHeader("Accept","application/json"),xhr.send(JSON.stringify(e))}function l(){for(var e=document.querySelectorAll('[js-dom = "dialog-product-delete"]'),t=0;t<e.length;t++)r(e[t]);function r(t){t.addEventListener("click",function(e){preventAll(e),function(e){var t=e.closest('[js-dom = "dialog-product"]').querySelector('[js-dom = "dialog-product-key-info"]').children,r=state.orderedProducts,o=t[2].textContent.trim();delete r[o],reqDeleteOrderQuantity({id:o})}(t),renderCart(),o()})}}function s(){for(var e=document.querySelectorAll('[js-dom = "dialog-product-select"]'),t=0;t<e.length;t++)r(e[t]);function r(t){t.addEventListener("click",preventAll),t.addEventListener("change",function(e){!function(e){var t=e.closest('[js-dom = "dialog-product"]').querySelector('[js-dom = "dialog-product-key-info"]').children,r=state.orderedProducts,o=t[2].textContent.trim();r[o].quantity=parseInt(e.value),reqPutOrderQuantity({id:o,quantity:r[o].quantity})}(t),renderCart(),o()})}}function o(){var e=state.orderedProducts,t=getOrderedProductsSummary(e);u.querySelector('[js-dom = "dialog-total-quantity"]').innerHTML=t.totalQuantity,u.querySelector('[js-dom = "dialog-total-price"]').innerHTML=t.totalPrice;for(var r=u.querySelector('[js-dom = "dialog-product-list"]');r.firstChild;)r.removeChild(r.firstChild);for(var o=0;o<3;o++)r.appendChild(c(3));var n=r.children,i=0;for(var a in e){n[i%3].appendChild(d(e[a])),i++}function c(e){var t='<div class="col-1-'+e+' smart-grid-padding"></div>',r=document.createElement("div");return r.innerHTML=t,r.firstChild}function d(e){var t=['<div class="card row" js-dom="dialog-product">','<a href="" js-dom="dialog-product-link">','<div class="card-image row">','<img src="" js-dom="dialog-product-img">',"</div>",'<div class="card-content row">','<div class="row key-info" js-dom="dialog-product-key-info">','<p class="title"></p>','<p class="price"></p>',"<p></p>","</div>",'<div clas="row">','<div class="col-1-3 select-wrapper">','<select name="quantity" dir="rtl" js-dom="dialog-product-select">','<option value="1">1</option>','<option value="2">2</option>','<option value="3">3</option>','<option value="4">4</option>','<option value="5">5</option>','<option value="6">6</option>','<option value="7">7</option>','<option value="8">8</option>','<option value="9">9</option>','<option value="10">10</option>',"</select>","</div>",'<div class="col-2-3">','<button class="row" type="button" js-dom="dialog-product-delete">','<i class="fas fa-trash-alt"></i>',"</button>","</div>","</div>","</div>","</a>","</div>"].join(""),r=document.createElement("div");r.innerHTML=t;var o=r.firstChild;o.querySelector('[js-dom = "dialog-product-link"]').setAttribute("href",e.href),o.querySelector('[js-dom = "dialog-product-img"]').setAttribute("src",e.src);var n=o.querySelector('[js-dom = "dialog-product-key-info"]').children;n[0].textContent=e.title,n[1].textContent="NT$"+String(e.price),n[2].textContent=e.id;for(var i=o.querySelector('[js-dom = "dialog-product-select"]').children,a=0;a<i.length;a++)if(parseInt(i[a].value)===e.quantity){i[a].selected=!0;break}return o}s(),l()}e.addEventListener("click",function(e){o(),u.classList.add("active")}),u.addEventListener("click",function(e){e.stopPropagation(),e.target===u&&u.classList.remove("active")}),t.addEventListener("click",function(e){e.stopPropagation(),u.classList.remove("active")}),document.querySelector('[js-dom = "confirm-payment"]').addEventListener("click",function(e){r(function(){var e=document.querySelector('[js-dom = "order-form"]'),t={name:e.querySelector("#name").value.trim(),mobile:e.querySelector("#mobile").value.trim(),email:e.querySelector("#email").value.trim(),address:e.querySelector("#address").value.trim(),cardZone1:e.querySelector("#cardZone1").value.trim(),cardZone2:e.querySelector("#cardZone2").value.trim(),cardZone3:e.querySelector("#cardZone3").value.trim(),cardZone4:e.querySelector("#cardZone4").value.trim(),cardSec:e.querySelector("#cardSec").value.trim(),cardExpMonth:e.querySelector("#cardExpMonth").value.trim(),cardExpYear:e.querySelector("#cardExpYear").value.trim(),orderedProducts:{}},r=state.orderedProducts;for(key in r)t.orderedProducts[key]={price:r[key].price,quantity:r[key].quantity};return t}())})}function initConfirmQuantity(){var e=document.querySelector('[js-dom = "confirm-quantity"]');e.addEventListener("click",function(e){!function(){var e=state.orderedProducts,t=document.querySelector('[js-dom = "link"]'),r=document.querySelector('[js-dom = "img-list"]').children[0].children[0],o=document.querySelector('[js-dom = "title"]'),n=document.querySelector('[js-dom = "price"]'),i=document.querySelector('[js-dom = "id"]').textContent.trim(),a=document.querySelector('[js-dom = "select"]');e[i]?e[i].quantity=parseInt(a.value.trim()):e[i]={src:r.src.trim(),href:t.getAttribute("href").trim(),title:o.textContent.trim(),price:parseInt(n.textContent.replace("NT$","").trim()),id:i,quantity:parseInt(a.value.trim())};reqPutOrderQuantity({id:i,quantity:e[i].quantity})}(),renderCart()})}reqGetOrder(),renderDialogForm(),initDialogForm(),initDialog(),initConfirmQuantity();